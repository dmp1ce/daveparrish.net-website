<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Dave Parrish - A better PKGBUILD template for AppImage packages</title>

        <!-- Stylesheets. -->
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/syntax.css" />

        <!-- Metadata. -->
        <meta name="keywords" content="daveparrish,drupal,haskell,liberty,bitcoin,linux,blog,hakyll" />
        <meta name="description" content="Dave Parrish - Hakyll blog" />
    </head>
    <body>
        <div id="main">
            <div id="header">
                <a href="../">
                    <img src="../images/lambda.png" alt="lambda" />
                    Dave Parrish's Blog
                </a>
            </div>
            <!-- Sidebar. -->
            <div id="sidebar">
                <a href="../index.html">Home</a>
                <a href="../about.html">About</a>
                <a href="../projects.html">Projects</a>
                <a href="../contact.html">Contact</a>
                <a href="../archive.html">Archive</a>

            </div>

            <div id="content">
		<h1>A better PKGBUILD template for AppImage packages</h1>
                <div class="info">Posted on November 16, 2019</div>

<hr />
<p>Presented here is a template for creating an Arch Linux desktop package from an AppImage. This improves on my last post <a href="../posts/2019-11-07-HowTo-PKGBUILD-for-AppImage.html">How to Create a PKGBUILD for a AppImage binary</a> which had the problem of not installing a <code>.desktop</code> file so the application can be started easily from GUI.</p>
<h2 id="the-template">The Template</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="co"># Maintainer: My name &lt;myemail@domain.me&gt;</span></a>
<a class="sourceLine" id="cb1-2" title="2"></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="va">_pkgname=</span>my-project</a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="va">pkgname=</span><span class="st">&quot;</span><span class="va">${_pkgname}</span><span class="st">&quot;</span>-appimage</a>
<a class="sourceLine" id="cb1-6" title="6"><span class="va">pkgver=</span>0.0.1</a>
<a class="sourceLine" id="cb1-7" title="7"><span class="va">pkgrel=</span>1</a>
<a class="sourceLine" id="cb1-8" title="8"><span class="va">pkgdesc=</span><span class="st">&quot;Description of my project&quot;</span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="va">arch=(</span><span class="st">'x86_64'</span><span class="va">)</span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="va">url=</span><span class="st">&quot;https://github.com/user/repo/&quot;</span></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="va">license=(</span><span class="st">'custom:Unlicense'</span><span class="va">)</span></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="va">depends=(</span><span class="st">'zlib'</span> <span class="st">'hicolor-icon-theme'</span><span class="va">)</span></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="va">options=(</span>!strip<span class="va">)</span></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="va">_appimage=</span><span class="st">&quot;</span><span class="va">${pkgname}</span><span class="st">-</span><span class="va">${pkgver}</span><span class="st">.AppImage&quot;</span></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="va">source_x86_64=(</span><span class="st">&quot;</span><span class="va">${_appimage}</span><span class="st">::https://github.com/user/repo/releases/download/</span><span class="va">${pkgver}</span><span class="st">/</span><span class="va">${_pkgname}</span><span class="st">.</span><span class="va">${pkgver}</span><span class="st">.AppImage&quot;</span></a>
<a class="sourceLine" id="cb1-16" title="16">               <span class="st">&quot;https://raw.githubusercontent.com/user/repo/</span><span class="va">${pkgver}</span><span class="st">/LICENSE&quot;</span></a>
<a class="sourceLine" id="cb1-17" title="17">              )</a>
<a class="sourceLine" id="cb1-18" title="18"><span class="va">noextract=(</span><span class="st">&quot;</span><span class="va">${_appimage}</span><span class="st">&quot;</span><span class="va">)</span></a>
<a class="sourceLine" id="cb1-19" title="19"><span class="va">sha256sums_x86_64=(</span><span class="st">'0000000000000000000000000000000000000000000000000000000000000000'</span></a>
<a class="sourceLine" id="cb1-20" title="20">                   <span class="st">'0000000000000000000000000000000000000000000000000000000000000000'</span>)</a>
<a class="sourceLine" id="cb1-21" title="21"></a>
<a class="sourceLine" id="cb1-22" title="22"><span class="fu">prepare()</span> <span class="kw">{</span></a>
<a class="sourceLine" id="cb1-23" title="23">    <span class="fu">chmod</span> +x <span class="st">&quot;</span><span class="va">${_appimage}</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb1-24" title="24">    <span class="ex">./</span><span class="st">&quot;</span><span class="va">${_appimage}</span><span class="st">&quot;</span> <span class="ex">--appimage-extract</span></a>
<a class="sourceLine" id="cb1-25" title="25"><span class="kw">}</span></a>
<a class="sourceLine" id="cb1-26" title="26"></a>
<a class="sourceLine" id="cb1-27" title="27"><span class="fu">build()</span> <span class="kw">{</span></a>
<a class="sourceLine" id="cb1-28" title="28">    <span class="co"># Adjust .desktop so it will work outside of AppImage container</span></a>
<a class="sourceLine" id="cb1-29" title="29">    <span class="fu">sed</span> -i -E <span class="st">&quot;s|Exec=AppRun|Exec=env DESKTOPINTEGRATION=false /usr/bin/</span><span class="va">${_pkgname}</span><span class="st">|&quot;</span>\</a>
<a class="sourceLine" id="cb1-30" title="30">        <span class="st">&quot;squashfs-root/</span><span class="va">${_pkgname}</span><span class="st">.desktop&quot;</span></a>
<a class="sourceLine" id="cb1-31" title="31">    <span class="co"># Fix permissions; .AppImage permissions are 700 for all directories</span></a>
<a class="sourceLine" id="cb1-32" title="32">    <span class="fu">chmod</span> -R a-x+rX squashfs-root/usr</a>
<a class="sourceLine" id="cb1-33" title="33"><span class="kw">}</span></a>
<a class="sourceLine" id="cb1-34" title="34"></a>
<a class="sourceLine" id="cb1-35" title="35"><span class="fu">package()</span> <span class="kw">{</span></a>
<a class="sourceLine" id="cb1-36" title="36">    <span class="co"># AppImage</span></a>
<a class="sourceLine" id="cb1-37" title="37">    <span class="fu">install</span> -Dm755 <span class="st">&quot;</span><span class="va">${srcdir}</span><span class="st">/</span><span class="va">${_appimage}</span><span class="st">&quot;</span> <span class="st">&quot;</span><span class="va">${pkgdir}</span><span class="st">/opt/</span><span class="va">${pkgname}</span><span class="st">/</span><span class="va">${pkgname}</span><span class="st">.AppImage&quot;</span></a>
<a class="sourceLine" id="cb1-38" title="38">    <span class="fu">install</span> -Dm644 <span class="st">&quot;</span><span class="va">${srcdir}</span><span class="st">/LICENSE&quot;</span> <span class="st">&quot;</span><span class="va">${pkgdir}</span><span class="st">/opt/</span><span class="va">${pkgname}</span><span class="st">/LICENSE&quot;</span></a>
<a class="sourceLine" id="cb1-39" title="39"></a>
<a class="sourceLine" id="cb1-40" title="40">    <span class="co"># Desktop file</span></a>
<a class="sourceLine" id="cb1-41" title="41">    <span class="fu">install</span> -Dm644 <span class="st">&quot;</span><span class="va">${srcdir}</span><span class="st">/squashfs-root/</span><span class="va">${_pkgname}</span><span class="st">.desktop&quot;</span>\</a>
<a class="sourceLine" id="cb1-42" title="42">            <span class="st">&quot;</span><span class="va">${pkgdir}</span><span class="st">/usr/share/applications/</span><span class="va">${_pkgname}</span><span class="st">.desktop&quot;</span></a>
<a class="sourceLine" id="cb1-43" title="43"></a>
<a class="sourceLine" id="cb1-44" title="44">    <span class="co"># Icon images</span></a>
<a class="sourceLine" id="cb1-45" title="45">    <span class="fu">install</span> -dm755 <span class="st">&quot;</span><span class="va">${pkgdir}</span><span class="st">/usr/share/&quot;</span></a>
<a class="sourceLine" id="cb1-46" title="46">    <span class="fu">cp</span> -a <span class="st">&quot;</span><span class="va">${srcdir}</span><span class="st">/squashfs-root/usr/share/icons&quot;</span> <span class="st">&quot;</span><span class="va">${pkgdir}</span><span class="st">/usr/share/&quot;</span></a>
<a class="sourceLine" id="cb1-47" title="47"></a>
<a class="sourceLine" id="cb1-48" title="48">    <span class="co"># Symlink executable</span></a>
<a class="sourceLine" id="cb1-49" title="49">    <span class="fu">install</span> -dm755 <span class="st">&quot;</span><span class="va">${pkgdir}</span><span class="st">/usr/bin&quot;</span></a>
<a class="sourceLine" id="cb1-50" title="50">    <span class="fu">ln</span> -s <span class="st">&quot;/opt/</span><span class="va">${pkgname}</span><span class="st">/</span><span class="va">${pkgname}</span><span class="st">.AppImage&quot;</span> <span class="st">&quot;</span><span class="va">${pkgdir}</span><span class="st">/usr/bin/</span><span class="va">${_pkgname}</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb1-51" title="51"></a>
<a class="sourceLine" id="cb1-52" title="52">    <span class="co"># Symlink license</span></a>
<a class="sourceLine" id="cb1-53" title="53">    <span class="fu">install</span> -dm755 <span class="st">&quot;</span><span class="va">${pkgdir}</span><span class="st">/usr/share/licenses/</span><span class="va">${pkgname}</span><span class="st">/&quot;</span></a>
<a class="sourceLine" id="cb1-54" title="54">    <span class="fu">ln</span> -s <span class="st">&quot;/opt/</span><span class="va">$pkgname</span><span class="st">/LICENSE&quot;</span> <span class="st">&quot;</span><span class="va">$pkgdir</span><span class="st">/usr/share/licenses/</span><span class="va">$pkgname</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb1-55" title="55"><span class="kw">}</span></a></code></pre></div>
<h2 id="explanation">Explanation</h2>
<p>After looking at a <a href="https://aur.archlinux.org/packages/?O=0&amp;K=appimage&amp;SB=v&amp;SO=d">few other AppImage PKGBUILDs</a> I realized some authors already had a solution for <code>.desktop</code> files. Their solution is:</p>
<ol type="1">
<li>Extract AppImage</li>
<li>Modify the <code>.desktop</code> so it works outside of the AppImage binary</li>
<li>Package the <code>.desktop</code> file and icon images</li>
</ol>
<p>These steps work well, but I was still faced with a nagging popup which prompted to add a <code>.desktop</code> file again! Fortunately, there seems to be a way to suppress the popup with the environment variable <code>DESKTOPINTEGRATION</code>, as I found by poking around in an AppImage I was trying to package. Keep in mind, not all AppImages have this popup problem, so the <code>DESKTOPINTEGRATION</code> variable might be unnecessary.</p>
<h2 id="credit">Credit</h2>
<p>Thank you to <a href="https://aur.archlinux.org/cgit/aur.git/tree/PKGBUILD?h=freecad-appimage">Igor Moura</a> and <a href="https://aur.archlinux.org/cgit/aur.git/tree/PKGBUILD?h=wootility-appimage">Frederik “Freso” S. Olesen</a> for their AppImage examples.</p>

<em>Modified: November 17, 2019 - 06:18:13 PM</em>

            </div>

            <div id="footer">
                Site proudly generated by <a href="http://github.com/jaspervdj/hakyll">hakyll</a>.<br />
                Generated HTML hosted on <a href="https://vultr.com">Vultr</a> and maintained with <a href="https://www.ansible.com">Ansible</a>.<br />
            </div>
        </div>
    </body>
</html>
